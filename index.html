<!DOCTYPE html>
<html>
<head>
  <title>KazmaTalk ğŸ“»</title>
</head>
<body>
  <h1>ğŸ“¡ KazmaTalkï¼ˆãƒˆãƒ©ãƒ³ã‚·ãƒ¼ãƒãƒ¼ï¼‰</h1>
  <button id="ptt">ğŸ™ï¸ æŠ¼ã—ã¦è©±ã™</button>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io("https://KazmaTalk.ã‚ãªãŸã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å.repl.co"); // â† è‡ªåˆ†ã®URLã«æ›¸ãæ›ãˆã¦ï¼

    const roomId = "default";
    let localStream = null;
    let connections = {};

    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
      localStream = stream;
      localStream.getAudioTracks()[0].enabled = false; // åˆæœŸã¯ç„¡éŸ³
    });

    socket.on("connect", () => {
      socket.emit("join", roomId);
    });

    socket.on("users-in-room", (users) => {
      users.forEach(connectTo);
    });

    socket.on("user-joined", connectTo);

    function connectTo(id) {
      const pc = new RTCPeerConnection();
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      connections[id] = pc;

      pc.onicecandidate = e => {
        if (e.candidate) {
          socket.emit("candidate", id, e.candidate);
        }
      };

      pc.ontrack = e => {
        const audio = new Audio();
        audio.srcObject = e.streams[0];
        audio.play();
      };

      pc.createOffer().then(offer => {
        pc.setLocalDescription(offer);
        socket.emit("offer", id, offer);
      });
    }

    socket.on("offer", (id, offer) => {
      const pc = new RTCPeerConnection();
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      connections[id] = pc;

      pc.onicecandidate = e => {
        if (e.candidate) {
          socket.emit("candidate", id, e.candidate);
        }
      };

      pc.ontrack = e => {
        const audio = new Audio();
        audio.srcObject = e.streams[0];
        audio.play();
      };

      pc.setRemoteDescription(offer).then(() => {
        return pc.createAnswer();
      }).then(answer => {
        pc.setLocalDescription(answer);
        socket.emit("answer", id, answer);
      });
    });

    socket.on("answer", (id, answer) => {
      connections[id].setRemoteDescription(answer);
    });

    socket.on("candidate", (id, candidate) => {
      connections[id].addIceCandidate(candidate);
    });

    document.getElementById("ptt").addEventListener("mousedown", () => {
      if (localStream) localStream.getAudioTracks()[0].enabled = true;
    });

    document.getElementById("ptt").addEventListener("mouseup", () => {
      if (localStream) localStream.getAudioTracks()[0].enabled = false;
    });
  </script>
</body>
</html>
